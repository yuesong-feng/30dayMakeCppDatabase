# day01-构建数据库引擎-B+树(Alt2，支持任意类型键值存储)

目前大部分数据库引擎的底层数据结构都采用B+树，B+树的详细介绍可以参考《数据库管理系统原理与设计（第3版）》第三部分第十章，也可以直接看CS 186的PPT。

在C++中构建一个B+树，需要注意B+树的以下特点：
- 节点中索引左边的值都小于索引，索引右边的值都大于等于索引
- 只有叶子节点储存数据，内部节点只储存索引
- 所有叶子结点连接成一个链表，方便顺序扫描
- 查找、插入、删除等操作的时间复杂度都应该是`O(logn)`
- 所有节点至少有`order/2`个key，最多有`order`个key，不满足时会自适应改变，高度也自平衡

B+树的数据有三种存储方式：
- Alt1: 数据和索引一起直接存储在叶子结点上
- Alt2: 叶子结点存储索引和一个数据指针
- Alt3: 叶子结点存储索引和多个数据指针

采用Alt1最大的缺点是可能导致B+树过大，无法全部放进内存，而第二种和第三种不管数据库多大几乎总可以将索引放进内存，查找更加快速。
本教程使用Alt2作为数据库引擎

构建B+树时，必须画图！！！

构建B+树时，必须画图！！！

构建B+树时，必须画图！！！

索引、指针的具体偏移位置，分离节点从哪儿开始拷贝，递归建立索引的不同情况，order是奇数、偶数的不同处理方式等，只有画图才能清楚。

掌握理基础后就可以在C++中定义B+树的结构：
```cpp
template<typename KeyT, typename ValT>
class Node{
public:
    bool leaf;
    Node *parent;   //for non-root only
    Node *next;     //for leaf only
    std::vector<KeyT> key;
    std::vector<ValT*> ptr2val;     //for leaf only
    std::vector<Node*> ptr2node;    //for non-leaf only
};
template<typename KeyT, typename ValT>
class BPTree{
private:
    Node<KeyT, ValT> *root;
};
```
- `leaf`表明该姐点是否为叶子节点
- `parent`指针指向该节点的父节点，根节点的`parent`为空
- `next`指针只存在于叶子节点，指向下一个叶子节点
- `key`储存节点的索引，最大为`order`
- `ptr2val`只存在于叶子节点，储存数据指针，大小必须和`key`的大小一样
- `ptr2node`只存在于非叶子节点，指向下一层的节点，大小必须等于`key.size()+1`

B+树也有细微的差别，如非叶子结点的最后一个索引有没有后指针等（我们这里定义的B+树有，这样更节约空间）。通过画图，可以清楚地看到定义的B+树结构。

需要注意的是，叶子结点储存的是数据指针、而不是数据本身，数据本身存储在内存（之后会在文件）里，通过该指针访问。
